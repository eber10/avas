---
import Image from "astro/components/Image.astro";
import Logo from "../assets/images/logo.png";
---

<div class="text-black w-80 mx-auto my-8 p-8 rounded-xl shadow-lg text-center">
    <form id="login-form" class="flex flex-col gap-4">
        <Image src={Logo} alt="Logo" class="w-36 mx-auto mb-4" />
        <h2 class="mb-6 font-bold text-xl">Mi Cuenta</h2>

        <div
            id="error-message"
            class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
        >
            <span class="block sm:inline"></span>
        </div>

        <div
            id="loading-message"
            class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4"
        >
            <span class="block sm:inline">Iniciando sesión...</span>
        </div>

        <div>
            <input
                type="text"
                name="username"
                placeholder="Usuario"
                required
                class="w-full p-3 rounded-md bg-beige-100 text-gray-800 text-base border-s-stone-600 border-1"
            />
        </div>
        <div>
            <input
                type="password"
                name="password"
                placeholder="Contraseña"
                required
                class="w-full p-3 rounded-md bg-beige-200 text-gray-800 text-base border-1 outline-amber-950"
            />
        </div>
        <button
            type="submit"
            id="submit-button"
            class="mt-2 w-full p-3 bg-beige-100 text-black font-bold rounded-md hover:bg-[#e5e5c0] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
            INICIAR SESIÓN
        </button>
    </form>

    <script type="module">
        const form = document.getElementById("login-form");
        const submitButton = document.getElementById("submit-button");
        const errorMessage = document.getElementById("error-message");
        const loadingMessage = document.getElementById("loading-message");

        function showError(message) {
            errorMessage.querySelector("span").textContent = message;
            errorMessage.classList.remove("hidden");
            loadingMessage.classList.add("hidden");
        }

        function showLoading() {
            loadingMessage.classList.remove("hidden");
            errorMessage.classList.add("hidden");
        }

        function hideMessages() {
            errorMessage.classList.add("hidden");
            loadingMessage.classList.add("hidden");
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            submitButton.disabled = true;
            showLoading();

            try {
                const formData = new FormData(form);

                const res = await fetch("http://localhost:4000/auth", {
                    method: "POST",
                    body: formData,
                });

                const data = await res.json();

                if (data.success) {
                    hideMessages();
                    window.location.href = data.redirectUrl;
                } else {
                    showError(data.message || "Error al iniciar sesión");
                }
            } catch (error) {
                console.error("Error de conexión:", error);
                showError("No se pudo conectar al servidor.");
            } finally {
                submitButton.disabled = false;
            }
        });
    </script>
</div>
